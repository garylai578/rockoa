/**
*	createname：雨中磐石
*	homeurl：http://xh829.com/
*	Copyright (c) 2016 rainrock (xh829.com)
*	Date:2016-01-01
*/

function addtabs(a){var c,d,b,e,f,g,h;if(a=js.apply({num:js.getrand(),scroll:!0,face:"images/white.gif",onshow:function(){},onclose:function(){}},a),b=a.num,nowtabs=a,changetabs(b))return!0;for(d=a.url.split(","),e="html/xinhu_"+d[0]+".shtml?rnd="+Math.random(),f='<div temp="tabs" onclick="changetabs(\''+b+'\')" id="tabs_'+b+'" class="lists active"><img src="'+a.face+'" align="absmiddle"> '+a.name+'<span class="close" onclick="closetabs(\''+b+'\')"><i class="icon-remove-sign"></i></span>',f+='<span id="tabs_stotal_'+b+'" class="badge bqs"></span>',f+="</div>","home"==b&&(f=""),$("#tabslist").append(f),$("#view_content").append('<div temp="content" id="content_'+b+'"></div>'),g="",c=1;c<d.length;c++)h=d[c].split("="),g+=",'"+h[0]+"':'"+h[1]+"'";""!=g&&(g=g.substr(1)),$.ajax({url:e,type:"get",success:function(c){var d,e;modeltabs("none"),$("#mainloaddiv").remove(),d=c,d=d.replace(/\{rand\}/gi,js.getrand()),d=d.replace(/\{params\}/gi,"var params={"+g+"};"),e=$("#content_"+b),e.html(d),a.onshow()},error:function(){modeltabs("none"),$("#mainloaddiv").remove();var a="Error:加载出错喽,"+e;$("#content_"+b).html(a)}}),tabsarr[b]=a}function modeltabs(a){if($("#tabsmodestese").remove(),"none"!=a){var b='<div id="tabsmodestese" oncontextmenu="return false" style="position:absolute;width:100%;height:100%;filter:Alpha(opacity=20);opacity:0.2;left:0px;top:0px;background-color:#000000;z-index:80;"><div style="margin-top:200px;color:white;text-align:center"><img src="images/mloading.gif" align="absmiddle">&nbsp;加载中...</div></div>';$("#view_content").append(b)}}function changetabs(a){if(!coloebool){$("div[temp='content']").hide(),$("div[temp='tabs']").removeClass(),$("div[temp='tabs']").addClass("lists");var b=!1;return get("content_"+a)&&($("#content_"+a).show(),$("#tabs_"+a).addClass("lists active"),$("#tabs_stotal_"+a).html(""),nowtabs=tabsarr[a],nowtabs.onshow(),b=!0),opentabs.push(a),b}}function closetabs(a){if("home"!=a){if(tabsarr[a]=!1,$("#content_"+a).remove(),$("#tabs_"+a).remove(),a==nowtabs.num){var c,d,b="home";for(c=opentabs.length-1;c>=0;c--)if(d=opentabs[c],get("content_"+d)){b=d;break}changetabs(b)}coloebool=!0,setTimeout("coloebool=false",10)}}function closenowtabs(){closetabs(nowtabs.num)}function bodyunload(){nwjs.removetray()}function connectserver(){return otherlogin?void 0:isempt(fromrecid)||0!=fromwshost.indexOf("ws:")?(js.msg("msg","暂时无法使用即时通信功能<br>请先到后台设置服务器信息",-1),void 0):(setTimeout("linkbooschange()",1e4),clearTimeout(relianshotime_time),"undefined"!=typeof websocketobj?(websocketobj.connect(),js.msg("wait","连接中..."),!1):(websocketobj=new websocketClass({adminid:adminid,reimfrom:fromrecid,wshost:fromwshost,sendname:adminname,onerror:function(){connectbool=!1,js.msg("msg",'无法连接服务器1<br><span id="lianmiao"></span><a href="javascript:;" onclick="return connectserver()">[重连]</a>',-1),relianshotime(30)},onmessage:function(a){connectbool=!0;var b=js.decode(a);im.receivemesb(b)},onopen:function(){connectbool=!0,js.msg("none"),im.initnotify()},onclose:function(){connectbool=!1,js.msg("msg",'连接已经断开了<br><span id="lianmiao"></span><a href="javascript:;" onclick="return connectserver()">[重连]</a>',-1),notifyobj.playerrsound(),relianshotime(30)}}),!1))}function serversend(a){return connectbool?(websocketobj.send(a),!0):!1}function sendtype(a,b){serversend({receid:a,type:b})}function linkbooschange(){otherlogin||connectbool||(js.msg("msg",'无法连接服务器2<br><span id="lianmiao"></span><a href="javascript:;" onclick="return connectserver()">[重连]</a>',-1),relianshotime(30))}function relianshotime(a){clearTimeout(relianshotime_time),$("#lianmiao").html("("+a+"秒后重连)"),0>=a?connectserver():relianshotime_time=setTimeout("relianshotime("+(a-1)+")",1e3)}function agentclass(a){var b=this;a=js.apply({id:0},a),this.receinfor={},this._init=function(){var c,d,g,e,f,h,i;for(c in a)this[c]=a[c];if(this.receinfor=agentarr[this.id],!this.receinfor)return js.msg("msg","应用不存在，请[设置-从新加载数据]后在试"),void 0;for(this.num=this.receinfor.num,this.name=this.receinfor.name,d=viewheight-41,this.showheight=d,this.showobj=$("#agentshow_"+this.rand),this.showobj.css("height",""+d+"px"),e=this.receinfor.menu,f=e.length,this.menus=e,h='<table width="100%" style="border-bottom:1px #dddddd solid" cellpadding="0"><tr><td nowrap>&nbsp;&nbsp;</td><td height="39"><div style="height:24px;overflow:hidden;padding-right:5px"><img src="'+this.receinfor.face+'" height="24"></div></td><td id="agenttitle_'+this.rand+'" nowrap>'+this.receinfor.name+'</td><td width="100%"></td>',g=0;f>g;g++)c=e[g],h+='<td oimenu="'+g+'" nowrap><span>'+c.name,c.submenu.length>0&&(h+=' <i class="icon-angle-down"></i>'),c.num&&(h+='	<font id="'+c.num+"_stotal_"+this.rand+'" class="badge"></font>'),h+="</span></td>";h+="</tr></table>",i=$("#agentheader_"+this.rand),i.html(h),i.find("[oimenu]").click(function(a){return b.clickmenu(this,a)}),agentobj[this.num]=this,this.loaddata(),this.submenuobj=$.rockmenu({data:[],itemsclick:function(a){b.clickmenuss(a)}})},this.setTitle=function(a){$("#agenttitle_"+this.rand).html(a)},this.clickevent=function(a){this.getdata(a.url,1)},this.clickmenu=function(a){var f,b=$(a),c=parseFloat(b.attr("oimenu")),d=this.menus[c],e=d.submenu.length;return 0>=e?(this.clickmenus(d),void 0):(f=b.offset(),this.submenuobj.setData(d.submenu),this.submenuobj.showAt(f.left,f.top+42,130),!1)},this.clickmenuss=function(a){this.clickmenus(a)},this.clickmenus=function(a){if(a.lx)return this.showmenuclick(a),void 0;if(0==a.type)return this.clickevent(a),void 0;if(1==a.type){var b=a.url,c=this.num;"add"==b.substr(0,3)&&("add"!=b&&(c=b.replace("add_","")),b="index.php?a=lu&m=input&d=flow&num="+c),0!=b.indexOf("http")&&(b=apiurl+b+""),im.openurl(a.name,b)}},this.initagent=function(){this.getdata("def",1)},this.loaddata=function(){var a=this.receinfor.url;"buin"==a?$.ajax({url:"html/yingyong/"+this.num+".html?rnd="+Math.random(),success:function(a){b.showobj.html(a),b.initagent()},error:function(){b.getdata("def",1)}}):b.initagent()},this.getdata=function(a,c){this.nowevent=a,modeltabs(),js.ajax("index","getyydata",{page:c,event:a,num:this.num},function(a){b.showdata(a)},"none")},this.regetdata=function(a,c){a&&$(a).html('<img src="images/loadings.gif" height="14" width="15" align="absmiddle"> 加载中...'),js.ajax("index","getyydata",{page:c,event:this.nowevent,num:this.num},function(a){b.showdata(a)},"none")},this.xiang=function(a,b){var g,c=this.data[a-1],d=c.id,e=c.modenum,f=c.modename;d&&(f||(f=this.name),e&&"undefined"!=e||(e=this.num),g=""+apiurl+"task.php?a=p&num="+e+"&mid="+d,b?js.open(g,750,500):im.openurl(f,g))},this.printexcel=function(a){var e,b=this.data[a-1],c=b.modenum,d=b.modename;d||(d=this.name),c&&"undefined"!=c||(c=this.num),e=""+apiurl+"task.php?a=e&num="+c+"&event="+this.nowevent,js.open(e,800,500)},this._showstotal=function(a){var b,c,e;for(b in a)c=a[b],0==c&&(c=""),e=$("#"+b+"_stotal_"+this.rand),e.html(c)},this.data=[],this.suboptmenu={},this.listright=function(a,b){var e,f,g,h,c=this.data[a-1],d=c.id;if(d){if(f=c.modenum,f&&"undefined"!=f||(f=this.num),this.tempid=d,this.tempnum=f,this.temparr={oi:a,evt:b},g=[{name:"详情",lx:998,oi:a,nbo:!1},{name:"详情(新窗口)",lx:998,oi:a,nbo:!0}],h=this.suboptmenu[""+f+"_"+d])for(e=0;e<h.length;e++)g.push(h[e]);else g.push({name:'<img src="images/loadings.gif" align="absmiddle"> 加载菜单中...',lx:999}),this.loadoptnum(f,d);g.push({name:"打印/导出...",lx:997,oi:a}),this.submenuobj.setData(g),this.submenuobj.showAt(b.clientX,b.clientY,130)}},this.loadoptnum=function(a,c){js.ajax("agent","getoptnum",{num:a,mid:c},function(d){b.suboptmenu[""+a+"_"+c]=d,b.listright(b.temparr.oi,b.temparr.evt)},"none")},this.showmenuclick=function(a){var c,d,e;return a.num=this.num,a.mid=this.tempid,a.modenum=this.tempnum,c=a.lx,c||(c=0),999!=c?998==c?(this.xiang(a.oi,a.nbo),void 0):997==c?(this.printexcel(a.oi),void 0):(this.changdatsss=a,2==c||3==c?(d="changeuser",3==c&&(d="changeusercheck"),js.changeuser(d,"yy",this.num),void 0):1==c||9==c||10==c?(e=1==a.issm?"必填":"选填",js.prompt(a.name,"请输入["+a.name+"]说明("+e+")：",function(c,d){"yes"==c&&(d||1!=a.issm?b.showmenuclicks(a,d):js.msg("msg","没有输入["+a.name+"]说明"))}),void 0):(this.showmenuclicks(a,""),void 0)):void 0},this.changeuser=function(a,b){if(b){var c=this.changdatsss,d="";c.changename=a,c.changenameid=b,this.showmenuclicks(c,d)}},this.showmenuclicks=function(a,c){c||(c=""),a.sm=c;for(var d in a)null==a[d]&&(a[d]="");js.ajax("index","yyoptmenu",a,function(){b.suboptmenu[""+a.modenum+"_"+a.mid]=!1,b.getdata(b.nowevent,1)})},this.showdata=function(a){var c,e,g,h,b="",d=a.rows.length,f="";for($("#showblank_"+this.rand).remove(),$("#notrecord_"+this.rand).remove(),"object"==typeof a.stotal&&this._showstotal(a.stotal),1==a.page&&(this.showobj.html(""),this.data=[]),c=0;d>c;c++)e=a.rows[c],g=this.data.push(e),"line"==e.showtype&&e.title?b='<div class="contline">'+e.title+"</div>":(e.statuscolor||(e.statuscolor=""),f="",1==e.ishui&&(f="color:#aaaaaa;"),b='<div oncontextmenu="agentobj.'+this.num+".listright("+g+',event)" onclick="agentobj.'+this.num+".xiang("+g+')" style="'+f+'" class="contlist">',e.title&&(b+='<div class="tit">'+e.title+"</div>"),e.optdt&&(b+='<div class="dt">'+e.optdt+"</div>"),e.cont&&(b+='<div class="cont">'+e.cont.replace(/\n/g,"<br>")+"</div>"),e.url&&(b+='<div class="xq">详情</div>'),e.statustext&&(b+='<div style="background-color:'+e.statuscolor+';opacity:0.7" class="zt">'+e.statustext+"</div>"),b+="</div>"),this.showobj.append(b);h=a.count,0==h&&(h=d),h>0?(b='<div class="showblank" id="showblank_'+this.rand+'">共'+h+"条记录",a.maxpage>1&&(b+=",当前"+a.maxpage+"/"+a.page+"页"),a.page<a.maxpage&&(b+=', <a onclick="agentobj.'+this.num+".regetdata(this,"+(a.page+1)+')" href="javascript:;">点击加载</a>'),b+="</div>",this.showobj.append(b),0==a.count&&$("#showblank_"+this.rand).html("")):this.showobj.html('<div class="notrecord" id="notrecord'+this.rand+'">暂无记录</div>')},this._init()}function rockupload(a){var b=this;a=js.apply({inputfile:"",uptype:"*",maxsize:50,onchange:function(){},onprogress:function(){},onsuccess:function(){},onerror:function(){},onabort:function(){}},a),this._init=function(){var c,d;for(c in a)this[c]=a[c];get(this.inputfile)||(d='<form style="display:none;height:0px;width:0px" name="form_'+this.inputfile+'"><input type="file" id="'+this.inputfile+'"></form>',$("body").append(d)),$("#"+this.inputfile).change(function(){b._change(this)})},this.reset=function(){document["form_"+this.inputfile].reset()},this.click=function(a){this.upbool||(a&&(this.uptype=a),get(this.inputfile).click())},this._change=function(a){var b,c,d,e,f;return a.files?(b=a.files[0],c={filename:b.name,filesize:b.size,filesizecn:js.formatsize(b.size)},b.size>1024*1024*this.maxsize?(this.reset(),js.msg("msg","文件不能超过"+this.maxsize+"MB,当前文件"+c.filesizecn),void 0):(d=b.name,e=d.substr(d.lastIndexOf(".")+1).toLowerCase(),"image"==this.uptype&&(this.uptype="jpg,gif,png,bmp,jpeg"),"*"!=this.uptype&&(f=","+this.uptype+",",f.indexOf(","+e+",")<0)?(js.msg("msg","禁止文件类型,请选择"+this.uptype),void 0):(c.fileext=e,c.isimg=js.isimg(e),this.filearr=c,this.onchange(c),this.reset(),this._startup(b),void 0))):(js.msg("msg","当前浏览器不支持1"),void 0)},this.sendbase64=function(a){this.filearr={filename:"截图.png",filesize:0,filesizecn:"",isimg:!0,fileext:"png"},this._startup(!1,a)},this._startup=function(a,c){var d,f,g;this.upbool=!0;try{d=new XMLHttpRequest}catch(e){return js.msg("msg","当前浏览器不支持2"),void 0}f=js.apiurl("upload","upfile"),c&&(f=js.apiurl("upload","upcont")),d.open("POST",f,!0),d.onreadystatechange=function(){b._statechange(this)},d.upload.addEventListener("progress",function(a){b._onprogress(a,this)},!1),d.addEventListener("load",function(){b._onsuccess(this)},!1),d.addEventListener("error",function(){b._error(this)},!1),a&&(g=new FormData,g.append("file",a),d.send(g)),c&&(d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c=c.substr(c.indexOf(",")+1),c=c.replace(/\+/g,"!"),c=c.replace(/\//g,"."),c=c.replace(/\=/g,":"),d.send("content="+c)),this.xhr=d},this._onsuccess=function(a){this.upbool=!1,this.onsuccess(this.filearr,a.response,a)},this._error=function(a){this.upbool=!1,js.getarr(a),this.onerror(this)},this._statechange=function(){},this._onprogress=function(a){var b=a.loaded,c=a.total,d=Math.floor(100*b/c);this.onprogress(this.filearr,d,a)},this.abort=function(){this.xhr.abort(),this.onabort()},this._init()}var relianshotime_time,nowtabs,notifyobj,systemtitle,chatclass,userarr={},deptarr={},agentarr={},connectbool=!1,fromrecid="",fromwshost="",otherlogin=!1,grouparr={},maindata={},tabsarr={},opentabs=[],chatobj={},agentobj={},windowfocus=!0,enterbool=!1,coloebool=!1,im={init:function(){im.initdata(),js.ajaxwurbo=!0,date=js.now(),im.resize(),$(window).resize(im.resize),$(window).focus(function(){windowfocus=!0}),$(window).blur(function(){windowfocus=!1}),notifyobj=new notifyClass({title:"系统提醒",sound:"res/sound/todo.ogg",sounderr:"res/sound/error.ogg",soundbo:!0}),righthistroboj=$.rockmenu({data:[],itemsclick:function(a){im.rightclick(a)}}),$("body").click(function(a){return js.downbody(this,a)}),addtabs({name:"桌面",num:"home",url:"home"}),$("#setbtns").click(function(){return im.clickcog(this),!1}),$("body").keydown(im.onkeyup),nwjs.init(),$(".msousou").keyup(function(){im.searchss()}),$(".msousou").click(function(){im.searchss()}),enterbool="1"==js.getoption("sendkey"),document.ondragover=function(a){a.preventDefault()},document.ondrop=function(a){a.preventDefault()}},resize:function(){var d,f,h,i,j,e,g,a=$(".main").height(),b=get("mainnw"),c=$(window).height();for(b?a=c+0:(d=.5*(c-a)-20,0>d&&(d=5),$(".main").css("margin-top",""+d+"px")),viewheight=a-50,e=$("div[resizeh]"),g=e.length,h=0;g>h;h++)f=$(e[h]),i=parseFloat(f.attr("resizeh")),j=viewheight-i,f.css("height",""+j+"px")},initbackd:function(a){a.userjson&&(maindata.darr=js.decode(a.deptjson),maindata.uarr=js.decode(a.userjson),maindata.garr=js.decode(a.groupjson),maindata.aarr=js.decode(a.agentjson),maindata.harr=js.decode(a.historyjson),im.showuser(maindata.uarr),adminmyrs=userarr[adminid],adminname=adminmyrs.name,adminface=adminmyrs.face,nwjs.createtray("信呼-"+adminname,1),im.showgroup(maindata.garr),im.showhistory(maindata.harr),im.showagent(maindata.aarr),get("myface").src=adminface,$("#myname").html(adminname),$("#myinfor").html(adminmyrs.deptname+"，"+adminmyrs.ranking),this.indexlunxun())},initdata:function(a){js.ajax("indexreim","indexinit",{},function(b){im.initbackd(b),js.servernow=b.loaddt,js.getsplit(),a||(fromrecid=b.config.recid,fromwshost=jm.base64decode(b.config.wsurl),connectserver())},"none")},indexlunxun:function(){clearTimeout(this.indexlunxtime),this.indexlunxtime=setTimeout("im.indexlunxuns();",6e5)},indexlunxuns:function(){this.ldata("history"),this.indexlunxun()},ldata:function(a){js.ajax("indexreim","ldata",{type:a,loaddt:jm.base64encode(js.servernow)},function(a){var e,b=a.type,c=js.decode(a.json);if(c.length,js.servernow=a.loaddt,"history"==b)for(e=0;length>e;e++)im.showhistorys(c[e],!0);"group"==b&&(maindata.garr=c,im.showgroup(c)),"user"==b&&(maindata.uarr=c,im.showuser(c)),"agent"==b&&(maindata.aarr=c,im.showagent(c)),"dept"==b&&(maindata.darr=c,$("#showdept_0").html(""))},"none")},showuser:function(a){var d,b=0,c=a.length;for(b=0;c>b;b++)d=a[b],userarr[d.id]=d},showgroup:function(a){var d,e,b=0,c=a.length,f=$("#grouplist_1");for(f.html(""),$("#grouptotal1").html("("+c+")"),b=0;c>b;b++)e=a[b],d='<div id="group_'+e.id+'"  onclick="im.opengroup('+e.id+')"><img src="'+e.face+'" align="absmiddle">'+e.name+"</div>",grouparr[e.id]=e,f.append(d)},tabchagne:function(a,b){$(".headertab div").removeClass(),b.className="active",$("#headercenter").find("div[tabdiv]").hide(),$("#headercenter").find("div[tabdiv='"+a+"']").show()},hidealislist:function(a,b){$("#grouplist_"+a).toggle();var c="xiangyou";"none"!=get("grouplist_"+a).style.display&&(c="xiangyou1"),$(b).find("img").attr("src","images/im/"+c+".png"),0==a&&this.showdept(0,0)},showdept:function(a,b){var f,c,d,e,g,h;if(im.clobbol=!0,c=0,d=maindata.darr.length,e="",g=$("#showdept_"+a),h=g.text())return g.toggle(),void 0;for(c=0;d>c;c++)f=maindata.darr[c],a==f.pid&&(e='<div style="padding-left:'+(20*b+10)+'px" onclick="im.showdept('+f.id+","+(b+1)+')">',e+='	<i class="icon-folder-close-alt"></i> '+f.name,e+="</div>",e+='<span id="showdept_'+f.id+'"></span>',g.append(e),0==a&&im.showdept(f.id,b+1));for(d=maindata.uarr.length,c=0;d>c;c++)f=maindata.uarr[c],a==f.deptid&&(e='<div style="padding-left:'+(20*b+10)+'px" onclick="im.openuser('+f.id+')">',e+='	<img src="'+f.face+'" align="absmiddle"> '+f.name+" <font>("+f.ranking+")<font>",e+="</div>",g.append(e))},showhistory:function(a){var b,c=a.length;for(b=0;c>b;b++)this.showhistorys(a[b])},showhistorys:function(a,b){var c,d,f,g,h,e,i,j;a&&(e=$("#historylist"),d=a.type,"user"==d&&(f=userarr[a.receid]),"group"==d&&(f=grouparr[a.receid]),i=""+d+"_"+a.receid,$("#history_"+i).remove(),f&&(j=a.optdt.substr(11,5),0!=a.optdt.indexOf(date)&&(j=a.optdt.substr(5,5)),h='oncontextmenu="im.rightdivobj=this" tsaid="'+a.receid+'" tsaype="'+a.type+'" ',g=a.stotal,"0"==g&&(g=""),c='<div class="lists" '+h+' rtype="hist" id="history_'+i+'" onclick="im.clickitems(\''+d+"',"+a.receid+')">',c+='<table cellpadding="0" border="0" width="100%"><tr>',c+='<td style="padding-right:8px"><img src="'+f.face+'"></td>',c+='<td align="left" width="100%"><div class="name">'+f.name+'</div><div class="huicont">'+jm.base64decode(a.cont)+"</div></td>",c+='<td align="center" nowrap><span id="histotal_'+i+'" class="badge">'+g+'</span><br><span style="color:#cccccc;font-size:10px">'+j+"</span></td>",c+="</tr></table>",c+="</div>",b?e.prepend(c):e.append(c)),$("#historylist_tems").hide(),this.changestotl(!1,0))},changestotl:function(a,b){var e,g,c,d,f,h,i;for(a||(a="histotal_"),c=$("span[id^='"+a+"']"),d=0,f=c.length,e=0;f>e;e++)g=$(c[e]).text(),""==g&&(g="0"),d+=parseFloat(g);0==d&&(d=""),$("#stotal_ss"+b).html(""+d),g=$("#stotal_ss0").text(),h=$("#stotal_ss1").text(),g||(g="0"),h||(h="0"),i=parseFloat(g)+parseFloat(h),nwjs.changeicon(i)},showagent:function(a){var b,e,f,c=a.length,d="";for($("#agentlist").html(""),d+='<table cellpadding="0" border="0" width="100%"><tr>',b=0;c>b;b++)f=a[b],agentarr[f.id]=f,e=f.stotal,0==e&&(e=""),d+='<td onclick="im.openagent('+f.id+',event);" class="agenttds cursor" width="33.3%"><div class="agenttd">',d+='	<span id="agentstotal_'+f.id+'" class="badge">'+e+"</span>",f.totals>0&&(d+="	<font></font>"),d+='	<div><img width="26" height="26" src="'+f.face+'"></div>',d+='	<div class="name">'+f.name+"</div>",d+="</div></td>",0==(b+1)%3&&(d+="</tr><tr>");d+="</tr></table>",$("#agentlist").html(d),$("#agentlist table").click(function(){return!1}),this.changestotl("agentstotal_",1)},showagents:function(a){var b="",c=a.stotal;0==c&&(c=""),b='<div onclick="im.openagent('+a.id+',event);return false;" class="lists">',b+='<table cellpadding="0" border="0" width="100%"><tr>',b+='<td style="padding-right:8px"><img src="'+a.face+'"></td>',b+='<td align="left" width="100%"><div class="name">'+a.name+"</div></td>",b+='<td align="center"><span id="agentstotal_'+a.id+'" class="badge">'+c+"</span></td>",a.totals>0&&(b+='<td nowrap>&nbsp;<i class="icon-angle-right"></i></td>'),b+="</tr></table>",b+="</div>",agentarr[a.id]=a,$("#agentlist").append(b)},clickitems:function(a,b){"user"==a&&this.openuser(b),"group"==a&&this.opengroup(b),"agent"==a&&this.openagent(b)},openagent:function(a,b){var e,f,g,h,i,j,c=agentarr[a],d=[];if(c){if(this.agentrightsub||(this.agentrightsub=$.rockmenu({data:[],width:150,iconswh:24,itemsclick:function(a){im.openagent(a.id)},resultbody:function(a){var b='<img src="'+a.face+'" width="24" height="24" align="absmiddle">&nbsp;'+a.name,c=agentarr[a.id];return c.stotal>0&&(b+='&nbsp;<font class="badge">'+c.stotal+"</font>"),b}})),this.agentrightsub.hide(),c.totals>0){for(f=c.subagent,e=0;e<f.length;e++)g=f[e],agentarr[g.id]=g,d.push(g);return this.agentrightsub.setData(d),this.agentrightsub.showAt(b.clientX-3,b.clientY-3),void 0}if(h=c.url,isempt(h))return h=apiurl+"task.php?fn=pcs_"+c.num+"&title="+jm.base64encode(c.name)+"&agentid="+a,js.open(h,800,500),void 0;addtabs({name:c.name,num:"agent_"+a,url:"agent,id="+c.id,face:c.face}),$("#agentstotal_"+a).html(""),c.pid>0&&(i=$("#agentstotal_"+c.pid),j=i.text(),""!=j&&(j=parseInt(j)-c.stotal),0>=j&&(j=""),i.html(""+j)),c.stotal=0,this.changestotl("agentstotal_",1)}},openchat:function(a,b,c,d){addtabs({name:a,num:""+b+"_"+c,url:"chat,uid="+c+",type="+b,face:d,onshow:function(){im.chatshow(this.num)}}),$("#histotal_"+b+"_"+c).html(""),this.changestotl(!1,0)},openuserzl:function(a){var c,b=userarr[a];b&&(isempt(b.tel)&&(b.tel=""),isempt(b.email)&&(b.email=""),isempt(b.sex)&&(b.sex="?"),c="<div>",c+='<div align="center" style="padding:10px;"><img id="myfacess" onclick="$(this).imgview()" src="'+b.face+'" height="80" width="80" style="border-radius:40px;border:1px #eeeeee solid">',a==adminid&&(c+='<br><a href="javascript:;" id="fupbgonet" onclick="im.upfaceobj.click()" style="font-size:12px">修改头像</a>'),c+="</div>",c+='<div style="line-height:25px;padding:10px;padding-left:40px;"><font color=#888888>姓名：</font>'+b.name+"<br><font color=#888888>部门：</font>"+b.deptname+"<br><font color=#888888>职位：</font>"+b.ranking+"<br><font color=#888888>性别：</font>"+b.sex+"<br><font color=#888888>电话：</font>"+b.tel+"<br><font color=#888888>邮箱：</font>"+b.email+"</div>",c+="</div>",js.tanbody("userziliao",""+b.name,250,350,{html:c}),a==adminid&&(this.upfaceobj=new rockupload({inputfile:"upfacess",uptype:"image",onsuccess:function(a,b){var c=js.decode(b);c.id&&js.ajax("reim","changeface",{id:c.id},function(a){var b=""+apiurl+a;get("myface").src=b+"?"+Math.random(),get("myfacess").src=b+"?"+Math.random(),adminface=b,js.setoption("adminface",b),$("#fupbgonet").html("修改成功")},"none")},onchange:function(){$("#fupbgonet").html("上传中...")}})))},openuser:function(a){var b=userarr[a];this.openchat(b.name,"user",a,b.face)},opengroup:function(a){var b=grouparr[a];this.openchat(b.name,"group",a,b.face)},otherlogin:function(){nwjs.winshow();var a="您的帐号已在别的地方登录";notifyobj.showpopup(a,{soundbo:!1}),js.confirm(a,function(){im.exitlogin()}),setTimeout("js.msg('none')",100),clearTimeout(relianshotime_time)},chatshow:function(a){var b=this.getchatobj(a);b&&(b.addcont(""),b.inputfocus()),$("#histotal_"+a).html("")},getchatobj:function(a){var b=chatobj[a];return b&&(b.isexist()||(b=!1)),b},loadgroup:function(){this.ldata("group")},loadagent:function(){this.ldata("agent")},onoffline:function(){},addhistory:function(a,b,c,d,e){var f={type:a,receid:b,stotal:c,cont:d,optdt:e};this.showhistorys(f,!0)},yiduall:function(a,b){js.ajax("reim","yiduall",{type:a,gid:b},!1,"none")},receivemesb:function(a){var d,e,h,i,j,k,l,b,c,f,g,m;return js.debug(a),b=a.type,c=a.adminid,f=!1,g="","offoline"==b?(this.otherlogin(),void 0):(m=userarr[c],m&&(a.sendname=m.name,a.face=m.face,l=a.gid,"onoffline"==b&&c!=adminid&&this.onoffline(c,a.cont),"getonline"==b&&this.onoffline(c,a.cont),("user"==b||"group"==b)&&(d=""+b+"_"+c,"group"==b&&(d=""+b+"_"+l),f=this.getchatobj(d),e=a.face,f&&(f.receivedata(a),d!=nowtabs.num&&(h=$("#tabs_stotal_"+d),i=h.text(),""==i&&(i="0"),i=parseFloat(i),h.html(i+1))),"group"==b&&(j=grouparr[l],j||(this.loadgroup(),j={face:"images/group.png"}),e=j.face),f&&windowfocus||("user"==b&&(g="人员["+a.sendname+"]，发来一条信息",notifyobj.showpopup(g,{icon:a.face,sendid:c,click:function(a){return im.openuser(a.sendid),!1}})),"group"==b&&(g="人员["+a.sendname+"]，发来一条信息，来自["+a.gname+"]",notifyobj.showpopup(g,{icon:j.face,gid:l,click:function(a){return im.opengroup(a.gid),!1}}))),h=$("#histotal_"+d),i=h.text(),""==i&&(i="0"),f||(i=parseFloat(i)+1),"user"==b&&this.addhistory(b,c,i,a.cont,a.optdt),"group"==b&&this.addhistory(b,l,i,a.cont,a.optdt)),"agent"==b&&(j=agentarr[l],j||(this.loadagent(),j={face:"images/logo.png",pid:0}),g=""+jm.base64decode(a.cont),k=a.title,k||(k=a.gname),notifyobj.showpopup(g,{icon:j.face,title:k,gid:l,url:a.url,click:function(a){return a.url?(js.open(a.url,740,500),!0):(im.openagent(a.gid),!1)}}),h=$("#agentstotal_"+l),0!=j.pid&&(h=$("#agentstotal_"+j.pid)),i=h.text(),""==i&&(i="0"),f||(i=parseFloat(i)+1),j.stotal=j.stotal+1,h.html(""+i),this.changestotl("agentstotal_",1)),"loadgroup"==b&&this.loadgroup()),void 0)},openrecord:function(){},bodyright:function(a){var d,c=$(im.rightdivobj).attr("rtype");isempt(c)||(d=[{name:"发消息",lx:0}],c.indexOf("agent")>-1&&d.push({name:"打开窗口",lx:1}),c.indexOf("hist")>-1&&d.push({name:"删除此记录",lx:2}),righthistroboj.setData(d),righthistroboj.showAt(a.clientX-3,a.clientY-3))},rightclick:function(a){var c,d,e,f,b=a.lx;99==b&&this.exitss(),21==b&&this.creategroup(),22==b&&this.indexsyscog(),23==b&&this.initdata(!0),24==b&&location.reload(),25==b&&this.editpass(),b>20||(c=$(im.rightdivobj),d=c.attr("tsaid"),e=c.attr("tsaype"),0==b&&("agent"==e&&im.openagents(d),"user"==e&&im.openuser(d),"group"==e&&im.opengroup(d)),1==b&&im.openagent(d),2==b&&(c.remove(),f=$("#historylist").text(),""==f&&$("#historylist_tems").show(),js.ajax("reim","delhistory",{type:e,gid:d},!1,"none")),3==b&&im.openrecord(e,d))},clickcog:function(a){var c,b=[{name:"＋创建会话",lx:21}];b.push({name:"设置",lx:22}),b.push({name:"修改密码",lx:25}),b.push({name:"重新加载数据",lx:23}),b.push({name:"刷新页面",lx:24}),b.push({name:"退出",lx:99}),righthistroboj.setData(b),c=$(a).offset(),righthistroboj.showAt(c.left,c.top-220)},backemts:function(a){var b=nowtabs.num;chatobj[b].backemts(a)},exitss:function(){js.confirm("确定要退出系统吗？",function(a){"yes"==a&&im.exitlogin()})},exitlogin:function(){js.ajax("login","loginexit",{},function(){js.location("login.html")})},nowsend:function(){var a=this.getchatobj(nowtabs.num);a&&a.sendcont()},entersend:function(){var a=this.getchatobj(nowtabs.num);a&&a.entersend()},onkeyup:function(a){var b=a.keyCode;if(27==b)return closenowtabs(),!1;if(enterbool&&!a.ctrlKey&&13==b)return im.nowsend(),!1;if(a.ctrlKey&&13==b)return enterbool?im.entersend():im.nowsend(),!1;if(a.altKey){if(83==b)return im.nowsend(),!1;if(67==b)return closenowtabs(),!1}return!0},editpass:function(){var a='<div style="padding:10px" align="center">';a+='<div>旧的密码：<input id="passoldPost" type="password" style="width:180px" class="input"></div>',a+='<div style="padding:5px 0px">新的密码：<input id="passwordPost" style="width:180px"  type="password" class="input"></div>',a+='<div>确认密码：<input id="password1Post" type="password" style="width:180px"  class="input"></div>',a+="</div>",js.tanbody("editpassa","修改密码",320,200,{html:a,btn:[{text:"确认修改"}]}),$("#editpassa_btn0").click(function(){im.editpassok()})},editpassok:function(){var e,a=get("passoldPost").value,b=get("passwordPost").value,c=get("password1Post").value,d="msgview_editpassa";return""==a?(js.setmsg("旧密码不能为空","red",d),get("passoldPost").focus(),!1):b.length<4?(js.setmsg("新密码不能少于4个字符","red",d),get("passwordPost").focus(),!1):/[a-zA-Z]{1,}/.test(b)&&/[0-9]{1,}/.test(b)?a==b?(js.setmsg("新旧密码不能相同","red",d),get("passwordPost").focus(),!1):b!=c?(js.setmsg("确认密码不一致","red",d),get("password1Post").focus(),!1):(e={passoldPost:a,passwordPost:b,password1Post:c},js.setmsg("修改中...","#ff6600",d),js.ajax("user","editpass",e,function(a){"success"==a?(js.setmsg("密码修改成功","green",d),js.msg("success","密码修改成功"),js.tanclose("editpassa")):(""==a&&(a="修改失败"),js.setmsg(a,"red",d))},"none"),void 0):(js.setmsg("新密码须字母+数字","red",d),get("passwordPost").focus(),!1)},creategroup:function(){var a='<div style="padding:10px">';return a+="<div>创建会话名称：</div>",a+='<div style="padding:10px"><input  class="input" id="keylasou" maxlength="8" style="width:150px"></div>',a+='<div style="padding:10px"><a class="webbtn" onclick="return false" id="yaoqingbtn" href="javascript:">确定</a>&nbsp;<span id="msgview_yaoqing"></span></div>',a+="</div>",js.tanbody("yaoqingla","创建会话",200,200,{html:a,bbar:"none"}),$("#yaoqingbtn").click(function(){var a=get("keylasou").value;return""==a?(js.setmsg("没有输入","red","msgview_yaoqing"),void 0):(js.setmsg("创建中...","","msgview_yaoqing"),js.ajax("reim","createlun",{val:jm.base64encode(a)},function(a){0==a.indexOf("success")?(js.msg("success","创建成功"),im.loadgroup(),js.tanclose("yaoqingla")):js.setmsg(a,"red","msgview_yaoqing")},"none"),void 0)}),get("keylasou").focus(),!1},changeuser:function(){},readclip:function(a){chatobj[nowtabs.num].readclip(a)},upbase64:function(a){var b=get("jietuimg_"+a);uploadobj.sendbase64(b.src)},initnotify:function(){var a=notifyobj.getaccess();"ok"!=a&&js.msg("msg",'为了可及时收到信息通知 <br>请开启提醒,<span class="zhu cursor" onclick="im.indexsyscog()">[开启]</span>',-1)},indexsyscogs:function(){var a=notifyobj.getnotifystr("im.indexsyscogss()");return"桌面通知提醒"+a},indexsyscogss:function(){notifyobj.opennotify(function(){$("#indexsyscog_msg").html(im.indexsyscogs())})},getsound:function(){var a=js.getoption("soundcog"),b=!1;return""==a&&(a="1"),1==a&&(b=!0),b},setsound:function(a){var b=a.checked?"1":"2";js.setoption("soundcog",b),notifyobj.setsound(a.checked)},indexsyscog:function(){var c,f,d,e,g,h,a=this.getsound()?"checked":"",b='<div style="height:130px;">';if(b+='<div style="padding:5px 0px;" id="indexsyscog_msg">'+this.indexsyscogs()+"</div>",b+='<div style="padding:5px 0px;border-top:1px #eeeeee solid"><label><input '+a+' onclick="im.setsound(this)" type="checkbox">新信息声音提示</label></div>',nwjsgui){for(c=js.getoption("kuaijj","Q"),d=nwjsgui.App.manifest.version,e="ABCEDFGHIJKLMNOPQRSTUVWYZ",g="",b+='<div style="padding:5px 0px;border-top:1px #eeeeee solid">&nbsp;当前版本V'+d+',<a href="javascript:;" onclick="nwjs.banben(this)">[检测版本]</a></div>',b+='<div style="padding:5px 0px;border-top:1px #eeeeee solid">&nbsp;打开窗口快捷键Ctrl+Alt+<select onchange="nwjs.changekuai(this)">',h=0;h<e.length;h++)f=e.substr(h,1),g="",c==f&&(g="selected"),b+="<option "+g+' value="'+f+'">'+f+"</option>";b+="</select></div>"}b+="</div>",js.tanbody("syscogshow","设置",270,200,{html:b,bodystyle:"padding:5px"})},searchss:function(){clearTimeout(this.searchsstime),this.searchsstime=setTimeout("im.searchssss()",500),this.searchright||(this.searchright=$.rockmenu({data:[],iconswh:20,itemsclick:function(a){im.clickitems(a.type,a.id)}}))},searchssss:function(){var e,f,g,d,a=$(".msousou"),b=strreplace(a.val()),c=[];if(""==b)return this.searchright.hide(),void 0;b=b.toLowerCase(),d=a.offset();for(e in userarr)f=userarr[e],(f.name.indexOf(b)>-1||0==f.pingyin.indexOf(b)||f.deptname.indexOf(b)>-1||f.ranking.indexOf(b)>-1)&&(g=""+f.name+"<font color=#888888>("+f.ranking+")</font>",c.push({name:g,id:f.id,icons:f.face,type:"user"}));for(e in grouparr)f=grouparr[e],f.name.indexOf(b)>-1&&(g=""+f.name+"<font color=#888888>(会话)</font>",c.push({name:g,id:f.id,icons:f.face,type:"group"}));for(e in agentarr)f=agentarr[e],f.name.indexOf(b)>-1&&(g=""+f.name+"<font color=#888888>(应用)</font>",c.push({name:g,id:f.id,icons:f.face,type:"agent"}));return 0==c.length?(this.searchright.hide(),void 0):(this.searchright.setData(c),this.searchright.showAt(d.left,d.top+26,210),void 0)},openurl:function(a,b){var c=430;js.tanbody("winiframe",a,700,c,{html:'<div style="height:'+c+'px"><iframe src="" name="winiframe" width="100%" height="100%" frameborder="0"></iframe></div>',bbar:"none"}),winiframe.location.href=b}};js.changeok=function(a,b,c,d){"yq"==c&&chatobj[d].yaoqing(b),"yy"==c&&agentobj[d].changeuser(a,b)},chatclass=function(a){var b=this;a=js.apply({type:"user",gid:0},a),this.receinfor={},this.minid=999999999,this._init=function(){var c,d,e;for(c in a)this[c]=a[c];this.receinfor=userarr[this.gid],"group"==this.type&&(this.receinfor=grouparr[this.gid]),d=viewheight-189,this.showobj=$("#showview_"+this.rand),this.showobj.css("height",""+d+"px"),this.inputobj=$("#input_content_"+this.rand),this.num=""+this.type+"_"+this.gid,this.inputobj.focus(),this.showobj.perfectScrollbar(),this.loaddata(),e='<table width="100%" style="border-bottom:1px #dddddd solid" cellpadding="0"><tr><td nowrap>&nbsp;&nbsp;</td><td height="39"><div style="height:24px;overflow:hidden"><img src="'+this.receinfor.face+'" height="24"></div></td><td nowrap>&nbsp;'+this.receinfor.name+'</td><td width="100%"></td>',e+='<td nowrap style="display:none"><span><i class="icon-wrench"></i>&nbsp;功能 <i class="icon-angle-down"></i></span></td>',"user"==this.type&&(e+='<td nowrap><span onclick="im.openuserzl('+this.gid+')"><i class="icon-user"></i>&nbsp;资料</span></td>'),"group"==this.type&&(e+="<td nowrap><span onclick=\"chatobj['"+this.num+'\'].groupuser()"><i class="icon-group"></i>&nbsp;人员 <i class="icon-angle-down"></i></span></td>',e+="<td nowrap><span onclick=\"js.changeuser('changecheckuser','yq','"+this.num+'\');"><i class="icon-plus"></i>&nbsp;邀请</span></td>'),e+="</tr></table>",$("#chatheader_"+this.rand).html(e),chatobj[this.num]=this,"undefined"==typeof uploadobj&&(uploadobj=new rockupload({inputfile:"allfileinput",onchange:function(a){b.changeup(a)
},onprogress:function(a,b,c){chatobj[this.chatnum].onprogresss(a,b,c)},onsuccess:function(a,b,c){chatobj[this.chatnum].upfilesuccess(a,b,c)}})),this.showobj.click(function(){$("#showuserl_"+b.rand).remove()}),this.charcontobj=$.rockmenu({data:[],itemsclick:function(a){b.clickmenuss(a)}})},this.changeup=function(a){var b=chatobj[nowtabs.num];b.sendfile(a)},this.yaoqing=function(a){"group"==this.type&&js.ajax("reim","yaoqinguid",{val:a,gid:this.gid},function(a){if(0==a.indexOf("success")){var c=a.replace("success","");js.msg("success","邀请成功"),""!=c&&(sendtype(c,"loadgroup"),b._regroupuser())}else js.msg("msg",a)})},this.sendfile=function(a,b){var c,d,e,f,g;uploadobj.chatnum=nowtabs.num,c=js.now("time"),d=js.serverdt(),this._sssnuid=c,this._sssoptdt=d,e='<div id="showve_'+c+'">',a&&(f=a.fileext,js.fileall.indexOf(","+f+",")<0&&(f="wz"),e+='<div><img src="images/fileicons/'+f+'.gif" align="absmiddle">&nbsp;'+a.filename+" ("+a.filesizecn+")</div>"),b&&(e+='<div><img src="'+b+'" id="jietuimg_'+c+'" width="150" height="150"></div>',e+="<div><a onclick=\"im.upbase64('"+c+'\')" href="javascript:;">[发送截图]</a> &nbsp; &nbsp; <a onclick="$(\'#ltcont_'+c+'\').remove();" href="javascript:;">[取消]</a>'),e+='<div class="progresscls"><div  id="progresscls_'+c+'" class="progressclssse"></div><div class="progressclstext"  id="progresstext_'+c+'">0%</div></div>',e+="</div>",g=strformat.showqp("right","我",d,e,c,adminface,c),this.addcont(g)},this.readclipshow=function(a){this.sendfile(!1,a)},this.onprogresss=function(a,b){$("#progresscls_"+this._sssnuid).css("width",""+b+"%"),$("#progresstext_"+this._sssnuid).html(""+b+"%")},this.upfilesuccess=function(a,b){var e,c=js.decode(b),d="";return $(".progresscls").remove(),c.id?(a.isimg?(e='<img src="'+apiurl+c.thumbpath+'" fid="'+c.id+'">',$("#showve_"+this._sssnuid).html(e),d="[图片 "+c.filesizecn+"]"):($("#progresstext_"+this._sssnuid).html("上传成功"),d="["+a.filename+" "+a.filesizecn+"]"),this.sendconts(jm.base64encode(d),this._sssnuid,this._sssoptdt,c.id),void 0):(this.senderror(this._sssnuid),js.msg("msg",b),void 0)},this.groupuser=function(){var b,a="showuserl_"+this.rand;return get(a)?($("#"+a).remove(),void 0):(b='<div id="'+a+'" style="background-color:#ffffff;border:1px #dddddd solid;position:absolute;left:0px;top:39px;z-index:10;width:100%;max-height:300px;overflow:auto;cursor:pointer;">',b+='<div align="center" style="padding:10px;"><img src="images/mloading.gif" align="absmiddle">&nbsp;加载中...</div>',b+="</div>",this.showobj.before(b),this.receinfor.groupuser?this._groupusershow(this.receinfor.groupuser):this._regroupuser(),void 0)},this._regroupuser=function(a){a&&$(a).html('<img src="images/loadings.gif" height="14" width="15" align="absmiddle"> 加载中...'),js.ajax("reim","getgroupuser",{type:this.type,gid:this.gid},function(a){b._groupusershow(a.uarr)},"none")},this._groupusershow=function(a){this.receinfor.groupuser=a,grouparr[this.gid].groupuser=a;var b,d,c=a.length,e="";for(e+='<table border="0" width="99%"><tr>',b=0;c>b;b++)d=a[b],e+='<td align="center" style="padding:5px 0px" onclick="im.openuserzl('+d.id+')" width="20%"><img src="'+d.face+'" height="40" width="40"><br><font color=#888888>'+d.name+"</font></td>",0==(b+1)%5&&(e+="</tr><tr>");e+="</tr></table>",e+='<div style="padding:5px; background-color:#f1f1f1">共'+c+"人,<a onclick=\"chatobj['"+this.num+'\']._regroupuser(this)" href="javascript:;">刷新</a>&nbsp;,&nbsp;<a onclick="chatobj[\''+this.num+'\']._exitgroup(this)" href="javascript:;">退出会话</a></div>',$("#showuserl_"+this.rand).html(e)},this.inputfocus=function(){this.inputobj.focus()},this.loaddata=function(a,c){var d;c=c?!0:!1,d=0,c&&(d=this.minid),a&&$(a).html('<img src="images/loadings.gif" height="14" width="15" align="absmiddle"> 加载中...'),js.ajax("reim","getrecord",{type:this.type,gid:this.gid,minid:d},function(d){a&&$(a).html(""),b.loaddatashow(d,c)},"none")},this.loadmoreda=function(a){this.loaddata(a,!0)},this._exitgroup=function(){js.confirm("确定要["+this.receinfor.name+"]会话吗？",function(a){"yes"==a&&b._exitgroups()})},this._exitgroups=function(){"group"==this.type&&js.ajax("reim","exitgroup",{gid:this.gid},function(){im.loadgroup(),closenowtabs(),$("#history_"+b.num).remove()})},this._contright=function(a,b){var e,c=$(a),d=c.attr("rand");this.randmess=d,e=[{name:"复制",lx:0},{name:"删除",lx:1}],"group"==this.type&&e.push({name:"@TA",lx:3}),e.push({name:"清除1月前记录...",lx:2}),this.charcontobj.setData(e),this.charcontobj.showAt(b.clientX,b.clientY,130)},this.clickmenuss=function(a){var d,e,c=a.lx;0==c&&(d=$("#qipaocont_"+this.randmess).text(),d&&this.addinput(d)),1==c&&($("#ltcont_"+this.randmess).remove(),e=this.randmess.replace("mess_",""),e&&js.ajax("reim","clearrecord",{type:this.type,gid:this.gid,ids:e},!1,"none")),2==c&&js.confirm("确定要清除1个月前的记录吗？",function(a){"yes"==a&&b.clearjilss(30)}),3==c&&(d=$("#ltname_"+this.randmess).text(),d&&this.addinput("@"+d)),(90==c||91==c)&&this.changesssssne(c)},this.clearjilss=function(a){js.ajax("reim","clearrecord",{type:this.type,gid:this.gid,day:a},function(){js.msg("success","清除成功")})},this.loaddatashow=function(a,c){var e,g,h,i,j,k,l,n,o,d=a.rows,f=d.length,m=[];if($("#loadmored_"+this.rand).remove(),c)f>0&&this.showobj.prepend('<div class="showblanks">---------↑以上是新加载---------</div>'),m=d;else for(e=f-1;e>=0;e--)m.push(d[e]);for(e=0;f>e;e++)l=m[e],h="right",i="我",j=adminface,l.sendid!=adminid&&(h="left",i=l.sendname,j=l.face),k=this.contshozt(l.filers),""==k&&(k=jm.base64decode(l.cont)),n="mess_"+l.id,g=strformat.showqp(h,i,l.optdt,k,"",j,n),c?this.showobj.prepend(g):this.addcont(g,c),$("#qipaocont_"+n).contextmenu(function(a){b._contright(this,a)}),l.id<this.minid&&(this.minid=l.id);f>0&&(o='<div id="histordiv_'+this.rand+'" class="showblanks" >',0==a.wdtotal?(o+="---------↑以上是历史记录---------",f>=5&&this.showobj.prepend('<div id="loadmored_'+this.rand+'" class="showblanks" ><a href="javascript:;" onclick="chatobj[\''+this.num+"'].loadmoreda(this)\">点击加载更多...</a></div>")):o+="---↑以上是历史,还有未读信息"+a.wdtotal+'条,<a href="javascript:;" onclick="chatobj[\''+this.num+"'].loaddata(this)\">点击加载</a>---",o+="</div>",c||this.addcont(o),c&&this._addclickf())},this.clearping=function(){var a="";get("loadmored_"+this.rand)&&(a='<div id="loadmored_'+this.rand+'" class="showblanks" ><a href="javascript:;" onclick="chatobj[\''+this.num+"'].loadmoreda(this)\">点击加载更多...</a></div>"),this.showobj.html(a)},this.contshozt=function(a){var c,b="";return a&&(a.fileid||(a.fileid=a.id),js.isimg(a.fileext)?b='<img src="'+apiurl+a.thumbpath+'" fid="'+a.fileid+'">':(c=a.fileext,js.fileall.indexOf(","+c+",")<0&&(c="wz"),b='<img src="images/fileicons/'+c+'.gif" align="absmiddle">&nbsp;'+a.filename+'<br><a href="javascript:;" onclick="js.downshow('+a.fileid+')">下载</a>&nbsp;'+a.filesizecn)),b},this.addcont=function(a,c){var d=this.showobj;a&&(c?d.prepend(a):d.append(a)),clearTimeout(this.scrolltime),this.scrolltime=setTimeout(function(){get("showview_"+b.rand)&&d.animate({scrollTop:get("showview_"+b.rand).scrollHeight},100),b._addclickf()},50)},this._addclickf=function(){var a=this.showobj.find("img[fid]");a.unbind("click"),a.click(function(){b.clickimg(this)})},this.clickimg=function(a){var d,b=$(a);b.attr("fid"),d=a.src.replace("_s.","."),$.imgview({url:d})},this.toolsclick=function(a){var d=$(a),e=d.attr("tools");"send"==e&&this.sendcont(),"emts"==e&&this.getemts(d),"clear"==e&&this.clearping(),"crop"==e&&this.cropScreen(),"file"==e&&uploadobj.click(),"change"==e&&this.changesend(d),"cropput"==e&&js.msg("msg","请使用快捷键Ctrl+V")},this.changesend=function(a){var d,b=[{name:"Ctrl+Enter发送",icons:"images/white.gif",lx:90},{name:"Enter发送",icons:"images/white.gif",lx:91}],c=js.getoption("sendkey");"1"==c?b[1].icons="images/ok.png":b[0].icons="images/ok.png",d=a.offset(),this.charcontobj.setData(b),this.charcontobj.showAt(d.left-135,d.top-75,150)},this.changesssssne=function(a){var b=a-90;js.setoption("sendkey",""+b),enterbool=1==b},this.cropScreen=function(){if(!nwjsgui)return js.msg("msg",'无法使用截屏，请使用客户端,<a href="http://xinhu.pw/" target="_blank">[去下载]</a>'),void 0;var a=this.getpath();nwjsgui.Shell.openItem(""+a+"/images/reimcaptScreen.exe")},this.getpath=function(){var a=nwjsgui.App.manifest.main,b=a.lastIndexOf("\\"),c=a.substr(0,b);return"file:"==c.substr(0,5)&&(c=c.substr(7)),c},this.readclip=function(a){var d,e,f,g,c=a.clipboardData;if(c)for(d=0;d<c.items.length;d++)e=c.items[d],"file"==e.kind&&e.type.match(/^image\//i)&&(f=e.getAsFile(),g=new FileReader,g.onload=function(){var a=this.result;b.readclipshow(a)},g.readAsDataURL(f))},this.isexist=function(){return get("showview_"+this.rand)},this.sendcont=function(a){var b,c,d,e,f,g;if(!js.ajaxbool)return js.msg("none"),b=this.inputobj,c=strformat.sendinstr(b.val()),c=c.replace(/</gi,"&lt;").replace(/>/gi,"&gt;").replace(/\n/gi,"<br>"),a&&(c=a),isempt(c)?!1:(d=jm.base64encode(c),d.length>500?(js.msg("msg","发送内容太多了"),void 0):(e=js.now("time"),f=js.serverdt(),g=strformat.showqp("right","我",f,c,e,adminface),this.addcont(g),b.val(""),b.focus(),this.sendconts(d,e,f,0),!1))},this.sendconts=function(a,c,d,e){im.addhistory(this.type,this.gid,0,a,d);var f={cont:a,gid:this.gid,type:this.type,nuid:c,optdt:d,fileid:e};js.ajax("reim","sendinfor",f,function(a){b.sendsuccess(a,c)},"none",!1,function(){b.senderror(c)})},this.entersend=function(){this.addinput("\n")},this.sendsuccess=function(a,b){var c;return this.bool=!1,a.id?($("#"+a.nuid).remove(),c=!1,a.messid=a.id,a.face=adminface,c=serversend(a),c||js.msg("msg","信息不能及时推送，但已保存到服务器"),void 0):(this.senderror(b),void 0)},this.receivedata=function(a){var d,e,c=jm.base64decode(a.cont);a.filename&&(c=this.contshozt(a)),d="mess_"+a.id,e=strformat.showqp("left",a.sendname,a.optdt,c,"",a.face,d),this.addcont(e),$("#qipaocont_"+d).contextmenu(function(a){b._contright(this,a)}),im.yiduall(this.type,this.gid)},this.senderror=function(a){js.ajaxbool=!1,get(a).src="images/error.png",get(a).title="发送失败"},this.getemts=function(a){var b,c,d;get("aemtsdiv")||(b='<div id="aemtsdiv" style="width:400px;height:200px;overflow-y:auto;border:1px #cccccc solid;background:white;box-shadow:0px 0px 5px rgba(0,0,0,0.3);left:3px;top:5px;position:absolute;display:none;z-index:6">',b+='<div style="padding:5px">',b+=this.getemtsbq("qq",0,104,11,24),b+="</div>",b+="</div>",$("body").append(b),js.addbody("emts","hide","aemtsdiv")),c=$("#aemtsdiv"),c.toggle(),d=a.offset(),c.css({top:""+(d.top-205)+"px",left:""+d.left+"px"})},this.getemtsbq=function(a,b,c,d,e){var f,g=0,h=js.float(100/d),i='<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr>';for(f=b;c>=f;f++)g++,i+='<td width="'+h+'%" title="'+strformat.emotsarr[f+1]+'" align="center"><img onclick="im.backemts(\''+strformat.emotsarr[f+1]+'\')" src="images/im/emots/'+a+"/"+f+'.gif" width="'+e+'" height="'+e+'"></td>',0==g%d&&(i+="</tr><tr>");return i+="</tr></table>"},this.backemts=function(a){this.addinput(a),$("#aemtsdiv").hide()},this.addinput=function(a){var b=this.inputobj;b.val(b.val()+a),b.focus()},this._init()};