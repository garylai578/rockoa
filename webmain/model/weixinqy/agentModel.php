<?php
 class weixinqy_agentClassModel extends weixinqyModel { public function initWeixin() { $this->settable('wxqy_agent'); } private function buttontojson($arr) { $str = ''; foreach($arr as $k=>$rs){ $str1=''; foreach($rs as $k1=>$v1)$str1.=',"'.$k1.'":"'.$v1.'"'; $str.=',{'.substr($str1, 1).'}'; } $str2 = '{"button":['.substr($str, 1).']}'; return $str2; } public function getagentarr() { $deptid = $this->option->getval('weixinqy_deptid'); if(isempt($deptid))$deptid = '1'; $url = URL; $domain = HOST; if(getconfig('systype')=='dev'){ $url = 'http://demo.rockoa.com/'; $domain = 'demo.rockoa.com'; } $arr[] = array( 'name' => '办公助手', 'description' => '当没有找到对应应用时，消息推送提醒将推送到办公助手上。', 'home_url' => '', 'menujson' => '[]' ); $arr[] = array( 'name' => 'OA主页', 'description' => '系统OA主页的入口地址。', 'home_url' => ''.$url.'?d=we&agentid={agentid}', 'menujson' => '[]' ); $arr[] = array( 'name' => '申请流程', 'description' => '添加录入流程数据。', 'home_url' => ''.$url.'?d=we&m=flow&a=apply&agentid={agentid}', 'menujson' => '[]' ); $menu= array( array( 'name' => '所有消息', 'type' => 'view', 'url' => ''.$url.'?d=we&m=ying&num=gong&agentid={agentid}', ), array( 'name' => '＋发公告', 'type' => 'view', 'url' => ''.$url.'?a=lum&m=input&d=flow&num=gong&agentid={agentid}', ) ); $arr[] = array( 'name' => '通知公告', 'description' => '系统发通知和功能使用的。', 'home_url' => ''.$url.'?d=we&m=ying&num=gong&agentid={agentid}', 'menujson' => $this->buttontojson($menu) ); $menu= array( array( 'name' => '所有待办', 'type' => 'view', 'url' => ''.$url.'?d=we&m=ying&num=daiban&agentid={agentid}', ), array( 'name' => '经过处理', 'type' => 'view', 'url' => ''.$url.'?d=we&m=ying&num=daiban&agentid={agentid}#jwcl', ) ); $arr[] = array( 'name' => '流程待办', 'description' => '提供流程待办消息推送提醒等。', 'home_url' => ''.$url.'?d=we&m=ying&num=daiban&agentid={agentid}', 'menujson' => $this->buttontojson($menu) ); $menu= array( array( 'name' => '今日会议', 'type' => 'view', 'url' => ''.$url.'?d=we&m=ying&num=meet&agentid={agentid}' ), array( 'name' => '新增会议', 'type' => 'view', 'url' => ''.$url.'?a=lum&m=input&d=flow&num=meet&agentid={agentid}' ) ); $arr[] = array( 'name' => '会议', 'description' => '会议通知。', 'home_url' => ''.$url.'?d=we&m=ying&num=meet&agentid={agentid}', 'menujson' => $this->buttontojson($menu) ); $menu= array( array( 'name' => '定位打卡', 'type' => 'view', 'url' => ''.$url.'?m=ying&d=we&a=daka&agentid={agentid}' ), array( 'name' => '考勤信息', 'type' => 'view', 'url' => ''.$url.'?m=ying&d=we&num=kqdkjl&agentid={agentid}' ), array( 'name' => '考勤统计', 'type' => 'view', 'url' => ''.$url.'?m=ying&d=we&num=kqtotal&agentid={agentid}' ) ); $arr[] = array( 'name' => '考勤', 'description' => '考勤打卡，外出打卡定位等', 'home_url' => ''.$url.'?m=ying&d=we&a=daka&agentid={agentid}', 'menujson' => $this->buttontojson($menu) ); $menu= array( array( 'name' => '我的日报', 'type' => 'view', 'url' => ''.$url.'?d=we&m=ying&num=daily&agentid={agentid}' ), array( 'name' => '写日报', 'type' => 'view', 'url' => ''.$url.'?a=lum&m=input&d=flow&num=daily&agentid={agentid}' ) ); $arr[] = array( 'name' => '工作日报', 'description' => '工作日报提醒，汇报等', 'home_url' => ''.$url.'?d=we&m=ying&num=daily&agentid={agentid}', 'menujson' => $this->buttontojson($menu) ); $menu= array( array( 'name' => '我的任务', 'type' => 'view', 'url' => ''.$url.'?d=we&m=ying&num=work&agentid={agentid}' ), array( 'name' => '创建任务', 'type' => 'view', 'url' => ''.$url.'?a=lum&m=input&d=flow&num=work&agentid={agentid}' ) ); $arr[] = array( 'name' => '任务', 'description' => '提供我的任务，下属任务，任务分配等。', 'home_url' => ''.$url.'?d=we&m=ying&num=work&agentid={agentid}', 'menujson' => $this->buttontojson($menu) ); foreach($arr as $k=>$rs){ $arr[$k]['redirect_domain'] = $domain; $arr[$k]['allow_userinfos'] = '{"user":[]}'; $arr[$k]['allow_partys'] = '{"partyid":['.$deptid.']}'; } return $arr; } public function daoruagent() { $rows = $this->getagentarr(); foreach($rows as $k=>$rs){ $name = $rs['name']; $where= "`name`='$name'"; $oldrs= $this->getone($where); if($oldrs){ $agentid = floatval($oldrs['agentid']); if($agentid>0){ $rs['home_url'] = str_replace('{agentid}', $agentid, $rs['home_url']); $rs['menujson'] = str_replace('{agentid}', $agentid, $rs['menujson']); } }else{ $where = ''; } $this->record($rs, $where); } $this->setbackarr(0, 'ok'); return $this->backarr; } public function getagent($id) { $token = $this->gettoken($id, true); if(isempt($token))return $this->tokenerr(); $url = ''.$this->gettourl('URL_agentget').'?access_token='.$token.'&agentid='.$id.''; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $oldrs = $this->getone("`agentid`='$id'"); $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode=='0'){ $uarr = array( 'name' => $arr->name, 'square_logo_url' => $arr->square_logo_url, 'description' => $arr->description, 'allow_userinfos' => json_encode($arr->allow_userinfos), 'allow_partys' => json_encode($arr->allow_partys), 'close' => $arr->close, 'redirect_domain' => $arr->redirect_domain, 'home_url' => $arr->home_url, 'report_location_flag' => $arr->report_location_flag, 'isreportenter' => $arr->isreportenter, ); if($oldrs && isempt($oldrs['square_logo_url'])){ unset($uarr['description']); unset($uarr['redirect_domain']); unset($uarr['home_url']); } $uwhee= ''; if($oldrs && $id=='0'){ $uwhee = "and `name`='".$oldrs['name']."'"; } $this->update($uarr, "`agentid`='$id' ".$uwhee.""); } } return $this->backarr; } public function setagent($id) { $rs = $this->getone("`agentid`='$id'"); if(!$rs)return $this->backarr; if(isempt($rs['square_logo_url'])){ $this->backarr['msg']='请先获取信息在更新'; return $this->backarr; } $home_url = str_replace('{agentid}', $id, $rs['home_url']); $menujson = str_replace('{agentid}', $id, $rs['menujson']); $body = '{"agentid": '.$id.',"name":"'.$rs['name'].'","report_location_flag":'.$rs['report_location_flag'].',"description":"'.$rs['description'].'","isreportenter":'.$rs['isreportenter'].',"home_url":"'.$home_url.'"'; if(!isempt($rs['redirect_domain']))$body .= ',"redirect_domain":"'.$rs['redirect_domain'].'"'; $body .= '}'; $body = str_replace('{agentid}', $id, $body); $token = $this->gettoken($id, true); if(isempt($token))return $this->tokenerr(); $url = ''.$this->gettourl('URL_agentset').'?access_token='.$token.''; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $this->update(array( 'home_url' => $home_url, 'menujson' => $menujson, ), $rs['id']); } } return $this->backarr; } public function getmenu($id) { $token = $this->gettoken($id, true); if(isempt($token))return $this->tokenerr(); $url = ''.$this->gettourl('URL_menuget').'?access_token='.$token.'&agentid='.$id.''; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result, true); $this->setbackarr($arr['errcode'], $arr['errmsg']); $button = $arr['button']; $this->backarr['button'] = $button; } return $this->backarr; } public function menuupdate($id) { $rs = $this->getone("`agentid`='$id'"); if(!$rs)return $this->backarr; $token = $this->gettoken($id, true); if(isempt($token))return $this->tokenerr(); $body = str_replace('{agentid}', $id, $rs['menujson']); $menu = json_decode($body, true); if(!$menu || isempt($body)){ $this->setbackarr(-1, '没有设置菜单,可以选择操作删除菜单'); return $this->backarr; } $body = str_replace('{agentid}', $id, $body); $url = ''.$this->gettourl('URL_menucreate').'?access_token='.$token.'&agentid='.$id.''; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $this->setbackarr($arr->errcode, $arr->errmsg); } return $this->backarr; } public function menudelete($id) { $rs = $this->getone("`agentid`='$id'"); if(!$rs)return $this->backarr; $token = $this->gettoken($id, true); if(isempt($token))return $this->tokenerr(); $url = ''.$this->gettourl('URL_menudelete').'?access_token='.$token.'&agentid='.$id.''; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result, true); $this->setbackarr($arr['errcode'], $arr['errmsg']); } return $this->backarr; } }