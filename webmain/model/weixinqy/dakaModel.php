<?php
class weixinqy_dakaClassModel extends weixinqyModel { public function getrecord($uidin='', $startdt='', $endddt='', $page=1) { $url = $this->gettourl('URL_checkindata'); $agentid = m('weixinqy:index')->getagentid('打卡'); $barr = $this->backarr; if($agentid==-1){ $msg= '请先添加打卡应用'; $barr['msg'] = $msg; return $barr; } $dt = $this->rock->date; if($startdt=='')$startdt = $dt; if($endddt=='')$endddt = $dt.' 23:59:59'; $starttime = strtotime($startdt); $endtime = strtotime($endddt); $maxpa = 99; $where = '1=1'; if($uidin!='')$where = 'a.`id` in('.$uidin.')'; $tables = "`[Q]admin` a left join `[Q]wxqy_user` b on a.`user`=b.`userid`"; $wheres = "b.`status`=1 and a.`status`=1 and $where"; $sql = "select a.`user`,a.`id` from $tables where $wheres limit ".(($page-1)*$maxpa).",$maxpa"; $urows = $this->db->getall($sql); $useridlist = ''; $uarrs = array(); $nextbo = 0; $countu = $this->db->rows($tables, $wheres); foreach($urows as $k=>$rs){ $useridlist.=',"'.$rs['user'].'"'; $uarrs[$rs['user']] = $rs['id']; } if($countu>=$maxpa)$nextbo = 1; if($useridlist==''){ $msg= '没有相关人员'; $barr['msg'] = $msg; return $barr; } $useridlist = substr($useridlist, 1); $token = $this->gettoken($agentid); $url .= '?access_token='.$token.''; $fenxiarr = array(); $body = '{"opencheckindatatype": 3,"starttime": '.$starttime.',"endtime": '.$endtime.',"useridlist": ['.$useridlist.']}'; $result = c('curl')->postcurl($url, $body); $okload = 0; $dbs = m('kqdkjl'); $dbs1 = m('location'); if($result!=''){ $arr = json_decode($result, true); $barr = $this->setbackarr($arr['errcode'], $arr['errmsg']); if($barr['errcode']==0 && isset($arr['checkindata'])){ $rows = $arr['checkindata']; $barr['checkindata'] = $rows; if(1==1)foreach($rows as $k=>$rs){ $userid = $rs['userid']; $checkin_type = $rs['checkin_type']; $exception_type = $rs['exception_type']; $uid = (int)$this->rock->arrvalue($uarrs, $userid, '0'); if($uid==0)continue; $dkdt = date('Y-m-d H:i:s', $rs['checkin_time']); if($checkin_type=='外出打卡'){ $where = "`uid`='$uid' and `optdt`='$dkdt' and `type`=2"; if($dbs1->rows($where)==0){ $okload++; $dbs1->insert(array( 'uid' => $uid, 'optdt' => $dkdt, 'type' => 2, 'label' => $rs['location_detail'], 'explain' => $rs['notes'], )); } }else if(isempt($exception_type) || $exception_type=='时间异常'){ $where = "`uid`='$uid' and `dkdt`='$dkdt' and `type`=7"; if($dbs->rows($where)==0){ $okload++; $dbs->insert(array( 'uid' => $uid, 'dkdt' => $dkdt, 'type' => 7, 'optdt' => $this->rock->now, 'address' => $rs['location_detail'], 'explain' => $rs['notes'], )); $dkdta = explode(' ', $dkdt); $fenxiarr[''.$dkdta[0].'|'.$uid] = $uid; } } } $barr['okload'] = $okload; } } $barr['nextbo'] = $nextbo; $barr['countu'] = $countu; $barr['maxpage'] = ceil($countu/$maxpa); if($fenxiarr){ $kqobj = m('kaoqin'); foreach($fenxiarr as $keys=>$uid){ $keysa = explode('|', $keys); $kqobj->kqanay($uid, $keysa[0]); } } return $barr; } public function getdkoption() { $url = $this->gettourl('URL_checkinoption'); $agentid = m('weixinqy:index')->getagentid('打卡'); $barr = $this->backarr; if($agentid==-1){ $msg= '请先添加打卡应用'; $barr['msg'] = $msg; return $barr; } $token = $this->gettoken($agentid); $url .= '?access_token='.$token.''; $body = '{"datetime":'.time().',"useridlist":["admin"]}'; $result = c('curl')->postcurl($url, $body); $barr = $this->backarr; if(!$this->isempt($result)){ $arr = json_decode($result); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $barr['errcode'] = 0; $this->getdkoptionss($arr->info); } } return $barr; } private function getdkoptionss($info) { $groupa = array(); foreach($info as $k=>$rs){ $group = $rs->group; $groupa[$group->groupid] = $group; } } }